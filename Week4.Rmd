---
title: "Storm Data Analysis"
author: "W. Aaron Morris"
output: 
  html_document: 
    fig_caption: yes
    fig_height: 10
    fig_width: 10
    keep_md: yes
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(cache = FALSE)

plot <- function(names, totals, columns, main, colors){
  colnames(totals) <- names
  
  par(las=2,mar=c(6,4,1,1))
  barplot(totals, col=colors,main=main,cex.names  = 0.6,cex.axis = 0.6)
  legend("topright", columns,fill=colors,bty = "n")
}
```

# Overview
Synopsis: Exploratory Analysis for the Storm Data Analysis

Goals: 1. Identify events that are harmful to the most people.
       2. Identify events that have the greatest finacial impact.


# Import Libraries
```{r import_libs}
library(dplyr)

```

# Read And Preprocess Data
```{r read_data, cache=TRUE}
StormData <- read.csv("data/StormData.csv.bz2")
colnames(StormData)
```

Look through Event Types

```{r CleanEventType}
event_types <- as.data.frame(table(StormData$EVTYPE))
event_types <- event_types[order(event_types$Var1), ]
event_types
```

Identify and Clean up Event Type Names
Multiple events are joined by a slash, ampersand, or the word and.
Everything else is adjusted for spelling errors or seperate nomenclature

While thes regular expressions don't get all the mistakes, they do get a majority.
```{r REGEX Change}
StormData$EVTYPE <- as.character(StormData$EVTYPE)
StormData$EVTYPE[grepl("/|&|and", StormData$EVTYPE,ignore.case = TRUE)] <- "Multiple Event"
StormData$EVTYPE[grepl("volc", StormData$EVTYPE,ignore.case = TRUE)] <- "Volcano"
StormData$EVTYPE[grepl("wind|wnd", StormData$EVTYPE,ignore.case = TRUE)] <- "WIND"
StormData$EVTYPE[grepl("funnel|tornado", StormData$EVTYPE,ignore.case = TRUE)] <- "Tornado"
StormData$EVTYPE[grepl("glaze", StormData$EVTYPE,ignore.case = TRUE)] <- "Glaze"
StormData$EVTYPE[grepl("hail", StormData$EVTYPE,ignore.case = TRUE)] <- "Hail"
StormData$EVTYPE[grepl("dust", StormData$EVTYPE,ignore.case = TRUE)]  <- "DUST"
StormData$EVTYPE[grepl("flood", StormData$EVTYPE,ignore.case = TRUE)] <- "FLOOD"
StormData$EVTYPE[grepl("ic(e|y)", StormData$EVTYPE,ignore.case = TRUE)] <- "Ice"
StormData$EVTYPE[grepl("fire|smoke", StormData$EVTYPE,ignore.case = TRUE)] <- "FIRE"
StormData$EVTYPE[grepl("thunder", StormData$EVTYPE,ignore.case = TRUE)] <- "Thunder Storm"
StormData$EVTYPE[grepl("slide|eros", StormData$EVTYPE,ignore.case = TRUE)] <- "Erosion"
StormData$EVTYPE[grepl("rain", StormData$EVTYPE,ignore.case = TRUE)] <- "Rain"
StormData$EVTYPE[grepl("freez|cold|snow|chill|winter", StormData$EVTYPE,ignore.case = TRUE)] <- "Cold Weather"
StormData$EVTYPE[grepl("TROPICAL.STORM", StormData$EVTYPE,ignore.case = TRUE)] <- "TROPICAL STORM"
StormData$EVTYPE[grepl("heat", StormData$EVTYPE,ignore.case = TRUE)] <- "Heat"
StormData$EVTYPE[grepl("(hurri|opal)", StormData$EVTYPE,ignore.case = TRUE)] <- "Hurricane"
```

# Seperate Data To Relevant Data for Question
```{r seperate data}
health <- StormData[,(c(8,23:24))]
property<-StormData[,c(8,25:28)]
```

# Population Health Question
## Health Totals
```{r Population Health Total}
health.totals <- aggregate(cbind(FATALITIES,INJURIES) ~ EVTYPE, data = health, sum, na.rm=TRUE)
health.totals$TOTAL <- health.totals$FATALITIES + health.totals$INJURIES
health.totals <- health.totals[order(-health.totals$TOTAL), ]
health.totals <- health.totals[1:25,]


plot(health.totals$EVTYPE,
     as.matrix(t(health.totals[,c(-1,-4)])),
     colors = c("dark blue","red"),
     columns = c("Fatalities","Injuries"),
     main = "Disaster Casualties")
```

## Health Averages
```{r Population Health Averages}
health.averages <- aggregate(cbind(FATALITIES,INJURIES) ~ EVTYPE, data = health, mean, na.rm=TRUE)
health.averages$TOTAL <- health.averages$FATALITIES + health.averages$INJURIES
health.averages <- health.averages[order(-health.averages$TOTAL), ]
health.averages <- health.averages[1:25,]


plot(health.averages$EVTYPE,
     as.matrix(t(health.averages[,c(-1,-4)])),
     colors = c("dark blue","red"),
     columns = c("Fatalities","Injuries"),
     main = "Disaster Casualties")

```

It is easily said that Tornado's cause the largest risk to the overall population health. However, there are several other events that might overtake Tornado's if they occurred more often.

# Economic Impact

Using the corrections to the Storm Data in the above Health Section, we will begin to look at the Economic Impact of certain types of events. 

We need to check the values of the economic data to ensure they are formated and corrected

```{r Load Property Data}
table(property$PROPDMGEXP)
table(property$CROPDMGEXP)
```

```{r Adjusting Damage Totals}
property$PROPDMGEXP<-factor(property$PROPDMGEXP,levels=c("H","K","M","B","h","m","O"))
property$PROPDMGEXP[is.na(property$PROPDMGEXP)] <- "O"

property$CROPDMGEXP<-factor(property$CROPDMGEXP,levels=c("K","M","B","k","m","O"))
property$CROPDMGEXP[is.na(property$CROPDMGEXP)] <- "O"

property$PROPDMGEXP <- as.character(property$PROPDMGEXP)
property$CROPDMGEXP <- as.character(property$CROPDMGEXP)

property$PROPDMGMLT <- 0
property$CROPDMGMLT <- 0

property$PROPDMGMLT[grepl("h", property$PROPDMGEXP,ignore.case = TRUE)]<-100
property$PROPDMGMLT[grepl("k", property$PROPDMGEXP,ignore.case = TRUE)]<-1000
property$PROPDMGMLT[grepl("m", property$PROPDMGEXP,ignore.case = TRUE)]<-1000000
property$PROPDMGMLT[grepl("b", property$PROPDMGEXP,ignore.case = TRUE)]<-1000000000
property$PROPDMGMLT[grepl("o", property$PROPDMGEXP,ignore.case = TRUE)]<-1

property$CROPDMGMLT[grepl("k", property$CROPDMGEXP,ignore.case = TRUE)]<-1000
property$CROPDMGMLT[grepl("m", property$CROPDMGEXP,ignore.case = TRUE)]<-1000000
property$CROPDMGMLT[grepl("b", property$CROPDMGEXP,ignore.case = TRUE)]<-1000000000
property$CROPDMGMLT[grepl("o", property$CROPDMGEXP,ignore.case = TRUE)]<-1


property$PROPDMG <- property$PROPDMG * property$PROPDMGMLT
property$CROPDMG <- property$CROPDMG * property$CROPDMGMLT
property$total <- property$PROPDMG + property$CROPDMG

head(property)
```

```{r Economic Total}
economic.total <- aggregate(cbind(PROPDMG,CROPDMG, total) ~ EVTYPE, data = property, sum, na.rm=TRUE)
economic.total <- economic.total[order(-economic.total$total), ]
economic.total <- economic.total[1:25,]

plot(economic.total$EVTYPE,
      as.matrix(t(economic.total[,c(-1,-4)])),
     colors = c("dark blue","red"),
     columns = c("Property Damage","Crop Damage"),
     main = "Economic Impact of Weather")
```     

```{r Economic Average}
economic.average <- aggregate(cbind(PROPDMG,CROPDMG, total) ~ EVTYPE, data = property, mean, na.rm=TRUE)
economic.average <- economic.average[order(-economic.average$total), ]
economic.average <- economic.average[1:25,]

plot(economic.average$EVTYPE,
      as.matrix(t(economic.average[,c(-1,-4)])),
     colors = c("dark blue","red"),
     columns = c("Property Damage","Crop Damages"),
     main = "Economic Impact of Weather")
```     

